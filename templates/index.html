<!DOCTYPE html>
<html>
  <head>
    <title>Temperature Monitoring</title>
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700|Lato:400,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
      body {
        background-color: #1e1e1e;
        color: #e0e0e0;
        font-family: 'Lato', sans-serif;
        margin: 0;
        padding: 20px;
      }
      h1, h2 { 
        font-family: 'Montserrat', sans-serif; 
        color: #ffffff;
      }
      .graph {
        margin-bottom: 20px;
      }
      .card {
        background-color: #1e1e1e;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        padding: 15px;
        margin-bottom: 20px;
      }
      .settings-row {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
      }
      .settings-field {
        flex: 1;
        min-width: 200px;
        margin: 10px;
      }
      form {
        margin: 10px 0;
      }
      input[type="number"],
      input[type="submit"] {
        padding: 8px;
        margin: 5px 0;
        border: none;
        border-radius: 4px;
      }
      input[type="number"] {
        width: 100%;
      }
      input[type="submit"] {
        background-color: #007bff;
        color: #fff;
        cursor: pointer;
      }
      input[type="submit"]:hover {
        background-color: #0056b3;
      }
      p {
        font-size: 1em;
      }
      .manual-control-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
    </style>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        // Attach auto-update listeners for form fields.
        document.getElementById("min_temp").addEventListener("change", autoUpdate);
        document.getElementById("max_temp").addEventListener("change", autoUpdate);
        document.getElementById("view_hours").addEventListener("change", autoUpdate);
        document.getElementById("manual_control").addEventListener("change", autoUpdate);
        
        // Trigger a resize event after a short delay to force Plotly to recalc dimensions.
        setTimeout(function() {
          window.dispatchEvent(new Event('resize'));
        }, 500);
      });
      
      function autoUpdate() {
        var form = document.getElementById("setpointsForm");
        var formData = new FormData(form);
        fetch("/", { method: "POST", body: formData })
          .then(response => response.text())
          .then(html => { document.open(); document.write(html); document.close(); })
          .catch(error => console.error("Error:", error));
      }
    </script>
  </head>
  <body>
    <!-- Graph Card -->
    <div class="card">
      {{ graph_div|safe }}
    </div>
    
    <!-- Settings Card -->
    <div class="card">
      <h2>Settings</h2>
      <form id="setpointsForm" method="POST">
        <div class="settings-row">
          <div class="settings-field">
            <label for="min_temp">Minimum Temperature (°C):</label>
            <input type="number" step="0.1" id="min_temp" name="min_temp" value="{{ min_temp }}" required>
          </div>
          <div class="settings-field">
            <label for="max_temp">Maximum Temperature (°C):</label>
            <input type="number" step="0.1" id="max_temp" name="max_temp" value="{{ max_temp }}" required>
          </div>
          <div class="settings-field">
            <label for="view_hours">Default View (hours):</label>
            <input type="number" step="1" id="view_hours" name="view_hours" value="{{ view_hours }}" required>
          </div>
        </div>
        <div class="settings-row">
          <div class="settings-field" style="flex: 1;">
            <h2 style="margin: 0;">Manual Relay Control</h2>
          </div>
          <div class="settings-field" style="flex: 0;">
            <input type="checkbox" id="manual_control" name="manual_control" {% if manual_control %}checked{% endif %}>
          </div>
        </div>
      </form>
      {% if manual_control %}
        <div class="settings-row">
          <div class="settings-field" style="width: auto;">
            <form method="POST">
              <input type="submit" name="toggle" value="Toggle Relay">
            </form>
          </div>
        </div>
      {% endif %}
      <p>Current Relay State: <strong>{{ current_relay_state.upper() }}</strong></p>
      <p>{{ message }}</p>
    </div>
  </body>
</html>
